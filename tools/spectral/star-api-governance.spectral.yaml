extends:
  - "spectral:oas"

rules:
  # ----------------------------
  # MUST (errors / publish blockers)
  # ----------------------------

  oas3-arrays-must-have-items:
    description: "MUST: array schemas must define items."
    message: "Array schema is missing `items`."
    severity: error
    given: "$..schemas[*]"
    then:
      function: schema
      functionOptions:
        schema:
          allOf:
            - if:
                properties:
                  type: { const: array }
              then:
                required: [items]

  oas3-no-invalid-exampleSetFlag:
    description: "MUST: forbid non-OpenAPI field `exampleSetFlag`."
    message: "Invalid field `exampleSetFlag` found. Use `x-...` vendor extension or remove."
    severity: error
    given: "$..exampleSetFlag"
    then:
      function: truthy

  oas3-securityschemes-required:
    description: "MUST: components.securitySchemes must exist."
    message: "components.securitySchemes is missing."
    severity: error
    given: "$"
    then:
      function: schema
      functionOptions:
        schema:
          type: object
          required: [components]
          properties:
            components:
              type: object
              required: [securitySchemes]

  patch-must-use-merge-patch:
    description: "MUST: PATCH should use application/merge-patch+json (or explicitly justified)."
    message: "PATCH requestBody must include 'application/merge-patch+json'."
    severity: error
    given: "$.paths[*][patch]"
    then:
      function: schema
      functionOptions:
        schema:
          type: object
          required: [requestBody]
          properties:
            requestBody:
              type: object
              required: [content]
              properties:
                content:
                  type: object
                  required: ["application/merge-patch+json"]

  # ----------------------------
  # SHOULD (warnings)
  # ----------------------------

  should-define-403-forbidden:
    description: "SHOULD: define 403 response for authorization failures."
    message: "Operation should define a 403 Forbidden response."
    severity: warn
    given: "$.paths[*][*].responses"
    then:
      function: schema
      functionOptions:
        schema:
          type: object
          required: ["403"]

  should-define-500-error:
    description: "SHOULD: define 500 response for internal errors."
    message: "Operation should define a 500 response."
    severity: warn
    given: "$.paths[*][*].responses"
    then:
      function: schema
      functionOptions:
        schema:
          type: object
          required: ["500"]

  should-avoid-criterias-in-paths:
    description: "SHOULD: avoid 'criterias' in paths; use 'criteria'."
    message: "Path contains 'criterias' (nonstandard plural). Use 'criteria'."
    severity: warn
    given: "$.paths.*~"
    then:
      function: pattern
      functionOptions:
        notMatch: "criterias"

  # ----------------------------
  # SHOULD (warnings) - STAR Naming Conventions
  # ----------------------------

  should-schema-names-be-pascalcase:
    description: "SHOULD: schema names must be PascalCase."
    message: "Schema name '{{property}}' should be PascalCase (e.g., PartMaster)."
    severity: warn
    given: "$.components.schemas.*~"
    then:
      function: pattern
      functionOptions:
        match: "^[A-Z][a-zA-Z0-9]*$"

  should-property-names-be-snake_case:
    description: "SHOULD: property names must be snake_case."
    message: "Property name '{{property}}' should be snake_case (lowercase with underscores)."
    severity: warn
    given: "$.components.schemas.*.properties.*~"
    then:
      function: pattern
      functionOptions:
        match: "^[a-z][a-z0-9_]*$"

  should-operationid-be-camelcase:
    description: "SHOULD: operationId must be camelCase."
    message: "operationId '{{value}}' should be camelCase (e.g., listPartOrders)."
    severity: warn
    given: "$.paths[*][*].operationId"
    then:
      function: pattern
      functionOptions:
        match: "^[a-z][a-zA-Z0-9]*$"

  should-enum-values-be-upper-snake-case:
    description: "SHOULD: enum values (for string enums) should be UPPER_SNAKE_CASE."
    message: "Enum value '{{value}}' should be UPPER_SNAKE_CASE."
    severity: warn
    given: "$..[?(@ && @.type=='string')].enum[*]"
    then:
      function: pattern
      functionOptions:
        match: "^[A-Z][A-Z0-9_]*$"

  # ----------------------------
  # MAY (info)
  # ----------------------------

  may-document-versioning:
    description: "MAY: include explicit versioning strategy (e.g., /v1 or headers)."
    message: "Consider documenting API versioning strategy."
    severity: info
    given: "$.info.version"
    then:
      function: truthy
